---
title: "HCP PCA"
author: "He Junhui"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(bigmemory)
library(irlba)
```

```{r}
inputpath = "G:/Phd/Data/HCPFMRI/WM_matrix/2bk-0bk.csv"
inputdata.bigmatrix = read.big.matrix(inputpath, type = "double")
```

+ PCA

```{r}
ncomponents = 500
chunks = 10
n = nrow(inputdata.bigmatrix); p = ncol(inputdata.bigmatrix)
batch_size = floor(p/chunks)
batch_npca = floor(ncomponents/chunks)
inputpca = c()
```

```{r}
t1 = Sys.time()
```

```{r}
for(i in c(1:(chunks-1))) {
  cat("The",i,"chunks...\n")
  chunkpca = prcomp_irlba(inputdata.bigmatrix[,((i-1)*batch_size+1):(i*batch_size)],n=batch_npca)
  inputpca = cbind(inputpca, chunkpca$x)
}
```


```{r}
t2 = Sys.time()
print(t2-t1)
# Time difference of 7.88653 mins
```

```{r}
write.csv(inputpca, "G:/Phd/Data/HCPFMRI/WM_matrix/pca2bk-0bk.csv")
```

